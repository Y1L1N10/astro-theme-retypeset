---
---

<div
  id="post-action-sidebar"
  class="fixed z-10 hidden flex-col gap-4 lg:bottom-20 lg:left-2 lg:top-auto min-[1920px]:left-[max(0.5rem,calc(50vw-58rem))] xl:left-[max(0.5rem,calc(50vw-45rem))] xl:top-1/2 lg:flex lg:translate-y-0 xl:-translate-y-1/2"
>
  <!-- Back Button -->
  <button
    id="action-back"
    class="action-btn group"
    aria-label="Go back"
    onclick="const siteTitleLink = document.getElementById('site-title-link'); if (siteTitleLink) { siteTitleLink.click() } else { window.location.href = '/' }"
  >
    <div class="icon-container">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        class="icon-default h-5 w-5"
      >
        <path d="M19 12H5" />
        <path d="M12 19l-7-7 7-7" />
      </svg>
    </div>
    <span class="tooltip">Go Back</span>
  </button>

  <!-- TOC Toggle Button -->
  <button
    id="action-toc"
    class="action-btn group"
    aria-label="Toggle Table of Contents"
  >
    <div class="icon-container">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        class="icon-list h-5 w-5"
      >
        <line x1="21" y1="10" x2="3" y2="10" />
        <line x1="21" y1="6" x2="3" y2="6" />
        <line x1="21" y1="14" x2="3" y2="14" />
        <line x1="21" y1="18" x2="3" y2="18" />
      </svg>
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        class="icon-close h-5 w-5"
      >
        <rect width="18" height="18" x="3" y="3" rx="2" ry="2" />
        <line x1="9" y1="3" x2="9" y2="21" />
        <path d="m14 15-3-3 3-3" />
      </svg>
    </div>
    <span class="tooltip">Contents</span>
  </button>

  <!-- Tags Button -->
  <button
    id="action-tags"
    class="action-btn group"
    aria-label="Jump to tags"
  >
    <div class="icon-container">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        class="icon-default h-5 w-5"
      >
        <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z" />
        <line x1="7" y1="7" x2="7.01" y2="7" />
      </svg>
    </div>
    <span class="tooltip">Tags</span>
  </button>

  <!-- Comment Button -->
  <button
    id="action-comment"
    class="action-btn group"
    aria-label="Jump to comments"
  >
    <div class="icon-container">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        class="icon-default h-5 w-5"
      >
        <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z" />
      </svg>
    </div>
    <span class="tooltip">Comment</span>
  </button>

  <!-- Share Button -->
  <button
    id="action-share"
    class="action-btn group"
    aria-label="Share this post"
  >
    <div class="icon-container">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        class="icon-original h-5 w-5"
      >
        <circle cx="18" cy="5" r="3" />
        <circle cx="6" cy="12" r="3" />
        <circle cx="18" cy="19" r="3" />
        <line x1="8.59" y1="13.51" x2="15.42" y2="17.49" />
        <line x1="15.41" y1="6.51" x2="8.59" y2="10.49" />
      </svg>
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        class="icon-success h-5 w-5"
      >
        <polyline points="20 6 9 17 4 12" />
      </svg>
    </div>
    <span class="tooltip">Share</span>
  </button>

  <!-- Back to Top Button -->
  <button
    id="action-top"
    class="action-btn group invisible relative opacity-0"
    aria-label="Back to top"
  >
    <!-- Progress Ring -->
    <svg class="absolute inset-0 h-full w-full transform p-0.5 -rotate-90" viewBox="0 0 40 40">
      <circle
        class="text-transparent"
        stroke="currentColor"
        stroke-width="2"
        fill="transparent"
        r="18"
        cx="20"
        cy="20"
      ></circle>
      <circle
        class="progress-ring-circle text-primary transition-all duration-100 ease-out"
        stroke="currentColor"
        stroke-width="2"
        fill="transparent"
        r="18"
        cx="20"
        cy="20"
        stroke-dasharray="113.1"
        stroke-dashoffset="113.1"
        stroke-linecap="round"
      ></circle>
    </svg>

    <!-- Percentage Text -->
    <span class="progress-text absolute inset-0 flex items-center justify-center text-[0.7rem] text-primary/80 font-bold leading-none transition-opacity duration-300 group-hover:opacity-0">
      0
    </span>

    <!-- Icon (Hidden by default, visible on hover) -->
    <div class="absolute inset-0 flex items-center justify-center opacity-0 transition-opacity duration-300 group-hover:opacity-100">
      <div class="icon-container">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="icon-default h-5 w-5"
        >
          <line x1="12" y1="19" x2="12" y2="5" />
          <polyline points="5 12 12 5 19 12" />
        </svg>
      </div>
    </div>
    <span class="tooltip">Top</span>
  </button>
</div>

<style>
  .action-btn {
    --at-apply: 'flex items-center justify-center w-10 h-10 rounded-full bg-secondary/5 text-secondary/60 hover:bg-primary/10 hover:text-primary transition-all duration-300 relative active:scale-90';
  }

  .action-btn::after {
    content: '';
    --at-apply: 'absolute inset-0 rounded-full border border-primary opacity-0 scale-100 pointer-events-none';
    transition: all 0.4s ease-out;
  }

  /* Share Button Success State */
  .action-btn.success {
    --at-apply: 'text-primary bg-primary/10';
  }
  .action-btn.success::after {
    --at-apply: 'opacity-0 scale-150';
    animation: ripple 0.6s ease-out;
  }

  /* TOC Button Active State */
  .action-btn.active {
    --at-apply: 'text-primary bg-primary/10';
  }

  @keyframes ripple {
    0% { opacity: 0.6; transform: scale(1); }
    100% { opacity: 0; transform: scale(1.6); }
  }

  /* Animations for other buttons */
  .animate-jump .icon-default {
    animation: jump-up 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  .animate-shake .icon-default {
    animation: shake 0.5s ease-in-out;
  }
  .animate-pulse .icon-default {
    animation: pulse-scale 0.4s ease-out;
  }

  @keyframes jump-up {
    0% { transform: translateY(0); }
    40% { transform: translateY(-50%); opacity: 0; }
    41% { transform: translateY(50%); opacity: 0; }
    100% { transform: translateY(0); opacity: 1; }
  }

  @keyframes shake {
    0%, 100% { transform: rotate(0); }
    25% { transform: rotate(-15deg); }
    75% { transform: rotate(15deg); }
  }

  @keyframes pulse-scale {
    0% { transform: scale(1); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
  }

  .icon-container {
    --at-apply: 'relative w-5 h-5';
  }

  /* Generic Transition */
  .icon-original, .icon-success, .icon-list, .icon-close, .icon-default {
    --at-apply: 'absolute inset-0 transition-all duration-500 ease-[cubic-bezier(0.34,1.56,0.64,1)]';
  }

  /* Share Icons */
  .icon-original { --at-apply: 'opacity-100 rotate-0 scale-100'; }
  .icon-success { --at-apply: 'opacity-0 rotate-90 scale-50'; }
  .action-btn.success .icon-original { --at-apply: 'opacity-0 -rotate-90 scale-50'; }
  .action-btn.success .icon-success { --at-apply: 'opacity-100 rotate-0 scale-100'; }

  /* TOC Icons */
  .icon-list { --at-apply: 'opacity-100 scale-100'; }
  .icon-close { --at-apply: 'opacity-0 scale-50'; }
  .action-btn.active .icon-list { --at-apply: 'opacity-0 scale-50'; }
  .action-btn.active .icon-close { --at-apply: 'opacity-100 scale-100'; }

  .tooltip {
    position: absolute;
    left: 100%;
    top: 50%;
    transform: translateY(-50%) translateX(0.25rem);
    margin-left: 0.5rem;
    padding: 0.375rem 0.75rem;
    font-size: 0.75rem;
    font-weight: 500;
    white-space: nowrap;
    pointer-events: none;
    z-index: 20;
    opacity: 0;
    transition: opacity 0.2s ease-out, transform 0.2s ease-out;

    /* Light mode styling */
    background: oklch(var(--un-preset-theme-colors-secondary) / 0.95);
    color: white;
    border-radius: 0.375rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  }

  /* Tooltip arrow */
  .tooltip::before {
    content: '';
    position: absolute;
    right: 100%;
    top: 50%;
    transform: translateY(-50%);
    border: 0.25rem solid transparent;
    border-right-color: oklch(var(--un-preset-theme-colors-secondary) / 0.95);
  }

  /* Hover state */
  .action-btn:hover .tooltip {
    opacity: 1;
    transform: translateY(-50%) translateX(0.5rem);
  }

  /* Dark mode adjustments */
  @media (prefers-color-scheme: dark) {
    .tooltip {
      background: oklch(var(--un-preset-theme-colors-primary-content) / 0.95);
      color: oklch(var(--un-preset-theme-colors-primary));
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .tooltip::before {
      border-right-color: oklch(var(--un-preset-theme-colors-primary-content) / 0.95);
    }
  }
  /* TOC Collapsed State: Only affect the fixed sidebar position via CSS */
  @media (min-width: 1280px) {
    :global(body.toc-collapsed) #post-action-sidebar {
      left: max(2rem, calc(50vw - 46rem));
    }

    :global(body.toc-collapsed) #toc-container {
      display: none !important;
    }
  }

  #post-action-sidebar {
    transition: left 0.3s ease-out;
  }
</style>

<script>
function setupPostActions() {
  // Guard: Only run if the sidebar exists (Post pages)
  if (!document.getElementById('post-action-sidebar'))
    return

  const showSuccess = (btn: HTMLElement) => {
    btn.classList.add('success')
    setTimeout(() => {
      btn.classList.remove('success')
    }, 2000)
  }

  const animateBtn = (btn: HTMLElement, animationClass: string) => {
    btn.classList.add(animationClass)
    btn.classList.add('success') // Trigger ripple
    setTimeout(() => {
      btn.classList.remove(animationClass)
      btn.classList.remove('success')
    }, 1000)
  }

  // Share (Keep existing)
  const shareBtn = document.getElementById('action-share')
  shareBtn?.addEventListener('click', async () => {
    try {
      await navigator.clipboard.writeText(window.location.href)
      showSuccess(shareBtn)
    }
    catch (err) {
      console.error('Failed to copy:', err)
    }
  })

  // Tags (Keep existing)
  const tagsBtn = document.getElementById('action-tags')
  tagsBtn?.addEventListener('click', () => {
    document.getElementById('post-tags')?.scrollIntoView({ behavior: 'smooth' })
    animateBtn(tagsBtn, 'animate-shake')
  })

  // Comment (Keep existing)
  const commentBtn = document.getElementById('action-comment')
  commentBtn?.addEventListener('click', () => {
    document.getElementById('post-comment')?.scrollIntoView({ behavior: 'smooth' })
    animateBtn(commentBtn, 'animate-pulse')
  })

  // TOC Toggle
  const tocBtn = document.getElementById('action-toc')
  const tocToggle = document.getElementById('toc-toggle') as HTMLInputElement | null
  const sidebarTarget = (document.getElementById('left-sidebar-placeholder') || document.getElementById('left-sidebar')) as HTMLElement | null
  const mainContent = document.getElementById('main-content')
  const TOC_COLLAPSED_KEY = 'toc-collapsed'

  const updateTOCState = () => {
    const isCollapsed = localStorage.getItem(TOC_COLLAPSED_KEY) === 'true'
    const isLargeScreen = window.innerWidth >= 1920

    // 1. Button State
    if (isCollapsed) {
      document.body.classList.add('toc-collapsed')
      tocBtn?.classList.remove('active') // Collapsed = List Icon
      if (tocToggle)
        tocToggle.checked = true
    }
    else {
      document.body.classList.remove('toc-collapsed')
      tocBtn?.classList.add('active') // Expanded = Close Icon
      if (tocToggle)
        tocToggle.checked = false
    }

    // 2. Layout Manipulation
    if (sidebarTarget && mainContent) {
      // If collapsed OR large screen (TOC expands outwards), keep content wide
      if (isCollapsed || isLargeScreen) {
        sidebarTarget.classList.remove('w-16rem', '-ml-38')
        sidebarTarget.classList.add('w-8', '-ml-32')

        mainContent.classList.remove('max-w-4xl')
        mainContent.classList.add('max-w-5xl', '2xl:max-w-6xl', '-ml-2')
      }
      else {
        // Standard behavior: Sidebar Expanded -> Pushes Content Right
        sidebarTarget.classList.add('w-16rem', '-ml-38')
        sidebarTarget.classList.remove('w-8', '-ml-32')

        mainContent.classList.add('max-w-4xl')
        mainContent.classList.remove('max-w-5xl', '2xl:max-w-6xl', '-ml-2')
      }
    }
  }

  // Initialize
  updateTOCState()

  // Update on resize
  window.addEventListener('resize', updateTOCState)

  // Cleanup on page transition
  document.addEventListener('astro:before-swap', () => {
    window.removeEventListener('resize', updateTOCState)
  }, { once: true })

  if (tocBtn) {
    tocBtn.addEventListener('click', () => {
      const isCurrentCollapsed = localStorage.getItem(TOC_COLLAPSED_KEY) === 'true'
      localStorage.setItem(TOC_COLLAPSED_KEY, (!isCurrentCollapsed).toString())
      updateTOCState()
    })
  }

  // Top & Progress (Keep existing logic...)
  const topBtn = document.getElementById('action-top')
  const progressCircle = topBtn?.querySelector('.progress-ring-circle') as SVGCircleElement | null
  const progressText = topBtn?.querySelector('.progress-text')

  if (topBtn && progressCircle && progressText) {
    const radius = progressCircle.r.baseVal.value
    const circumference = radius * 2 * Math.PI
    progressCircle.style.strokeDasharray = `${circumference} ${circumference}`
    progressCircle.style.strokeDashoffset = `${circumference}`

    const setProgress = (percent: number) => {
      const offset = circumference - (percent / 100) * circumference
      progressCircle.style.strokeDashoffset = `${offset}`
      progressText.textContent = `${Math.round(percent)}`
    }

    const onScroll = () => {
      const scrollTop = window.scrollY
      const docHeight = document.documentElement.scrollHeight - window.innerHeight
      const scrollPercent = docHeight > 0 ? (scrollTop / docHeight) * 100 : 0
      setProgress(Math.min(100, Math.max(0, scrollPercent)))
      topBtn.classList.toggle('opacity-0', scrollTop <= 0)
      topBtn.classList.toggle('invisible', scrollTop <= 0)
    }

    window.addEventListener('scroll', onScroll, { passive: true })
    onScroll()
    document.addEventListener('astro:before-swap', () => window.removeEventListener('scroll', onScroll), { once: true })
    topBtn.addEventListener('click', () => {
      window.scrollTo({ top: 0, behavior: 'smooth' })
      animateBtn(topBtn, 'animate-jump')
    })
  }
}

// Apply state immediately to prevent flash (optional, but good practice)
const TOC_COLLAPSED_KEY = 'toc-collapsed'
if (typeof localStorage !== 'undefined' && localStorage.getItem(TOC_COLLAPSED_KEY) === 'true') {
  document.body.classList.add('toc-collapsed')
}

document.addEventListener('astro:page-load', setupPostActions)
setupPostActions()
</script>
```
