---
/**
 * 简化版热力图组件 - 纯 Astro 实现
 * 不依赖 Svelte，不需要客户端 JS
 */
import { getPostPath } from '@/i18n/path'
import { addDays, diffDays, formatDate, getWeekday, isWeekend, subtractDays } from '@/utils/time-simple'
import { getGitHubContributions } from '@/utils/github-contributions'

interface Props {
  posts: Array<{
    id: string
    data: {
      title: string
      published: Date
      abbrlink?: string
      [key: string]: any
    }
  }>
  locale?: string
  lang?: string
  startDate?: string // 可选：指定开始日期 (YYYY-MM-DD)
  githubUser?: string
}

const { posts, locale = 'zh-CN', lang = '', startDate, githubUser } = Astro.props
const now = new Date()

// 确定起始日期和天数
let start: Date
let days: number

if (startDate) {
  // 自定义模式：从指定日期对齐到周六后往前显示一年
  const customDate = new Date(startDate)
  const weekday = getWeekday(customDate)
  // 如果不是周六，找到这周或下周的周六
  const daysUntilSaturday = weekday === 6 ? 0 : (6 - weekday + 7) % 7
  start = addDays(customDate, daysUntilSaturday)
  days = 52 * 7 // 固定显示52周(一年)
}
 else {
  // 默认模式：从今天对齐到本周六（包含今天所在的整周）
  const weekday = getWeekday(now)
  // 计算距离本周六还有几天 (0=周日...6=周六)
  const daysToNextSaturday = 6 - weekday
  start = addDays(now, daysToNextSaturday)
  days = 52 * 7 // 固定显示52周(一年)
}

// 获取 GitHub 数据
let githubData = new Map<string, number>()
if (githubUser) {
  githubData = await getGitHubContributions(githubUser)
}

// 创建热力图数据结构
type HeatmapDay = {
  date: Date
  posts: typeof posts
  githubCount: number
}

const heatmap: HeatmapDay[] = Array.from({ length: days }, (_, day) => ({
  date: subtractDays(start, day),
  posts: [],
  githubCount: 0,
}))

// 填充文章数据
for (const post of posts) {
  const postDate = post.data.published
  if (!postDate)
    continue

  const gap = diffDays(start, postDate)
  if (gap >= 0 && gap < days) {
    heatmap[gap].posts.push(post)
  }
}

// 填充 GitHub 数据
if (githubUser) {
  heatmap.forEach((day) => {
    const dateStr = day.date.toISOString().split('T')[0]
    if (githubData.has(dateStr)) {
      day.githubCount = githubData.get(dateStr)!
    }
  })
}

// 反转数组，让最新的在右边
heatmap.reverse()

// 拆分成两个半年的热力图
const halfPoint = Math.ceil(heatmap.length / 2)
const firstHalf = heatmap.slice(0, halfPoint) // 前半年（较早）
const secondHalf = heatmap.slice(halfPoint) // 后半年（较新）

// 生成文章链接
function getPostUrl(post: typeof posts[0]): string {
  // 使用 abbrlink 或 id 作为 slug
  const slug = post.data.abbrlink || post.id
  return getPostPath(slug, lang)
}

// 辅助函数：计算活跃等级
function getLevel(count: number): number {
  if (count >= 5)
return 3
  if (count >= 3)
return 2
  if (count >= 1)
return 1
  return 0
}

// 辅助函数：获取颜色类名
function getColorClass(level: number, hasPost: boolean): string {
  if (level === 0)
return 'level-0'
  const type = hasPost ? 'post' : 'github'
  return `type-${type}-level-${level}`
}

// 辅助函数：获取月份标签
function getMonthLabels(days: HeatmapDay[]) {
  const months: { index: number; label: string }[] = []
  let currentMonth = -1
  let lastLabelIndex = -999

  // 按周遍历（每7天一列）
  for (let i = 0; i < days.length; i += 7) {
    const date = days[i].date
    const month = date.getMonth()
    const colIndex = Math.floor(i / 7)

    if (month !== currentMonth) {
      // 只有当距离上一个标签足够远时才显示（避免重叠）
      if (colIndex - lastLabelIndex >= 2) {
        months.push({
          index: colIndex,
          label: new Intl.DateTimeFormat('en-US', { month: 'short' }).format(date),
        })
        lastLabelIndex = colIndex
      }
      currentMonth = month
    }
  }
  return months
}

const firstHalfMonths = getMonthLabels(firstHalf)
const secondHalfMonths = getMonthLabels(secondHalf)

// 统计数据计算
let totalContributions = 0
let maxStreak = 0
let currentStreak = 0
let tempStreak = 0

// 按时间顺序遍历所有天数（heatmap 已经是倒序的，需要反过来或者直接处理）
// heatmap 是从今天(index 0)倒推到一年前。
// 为了计算 streak，我们最好按时间正序遍历
const sortedDays = [...heatmap].reverse() // 变为旧 -> 新

// 使用 chinese-days 库进行精确的节假日判断
import chineseDays from 'chinese-days'
const { isWorkday } = chineseDays

function isRestDay(date: Date): boolean {
  // 判断是否为中文环境
  const isChinese = locale?.toLowerCase().startsWith('zh')

  if (isChinese) {
    // 构造 YYYY-MM-DD 字符串以避免时区问题
    const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`
    // 在中国，休息日 = 非工作日 (包含周末且非调休，以及法定节假日)
    return !isWorkday(dateStr)
  }

  // 其他语言环境，默认仅周末为休息日
  // 如果需要支持其他国家节假日，可以引入 date-holidays 等库
  return isWeekend(date)
}

sortedDays.forEach((day) => {
  const count = day.posts.length + day.githubCount
  totalContributions += count

  if (count > 0) {
    tempStreak++
    if (tempStreak > maxStreak) {
      maxStreak = tempStreak
    }
  }
 else if (!isRestDay(day.date)) {
    // 只有在非休息日且无贡献时，才断开 streak
    // 如果是休息日且无贡献，streak 保持不变（不增加也不清零）
    tempStreak = 0
  }
})

// 计算当前连续打卡
// sortedDays 是 New -> Old (Nov 22 -> Jan)
// 我们需要从最新的日期开始往回查
for (let i = 0; i < sortedDays.length; i++) {
  const day = sortedDays[i]
  const diff = diffDays(day.date, now)
  
  // 跳过未来的日期
  if (diff > 0) {
    continue
  }

  const count = day.posts.length + day.githubCount
  if (count > 0) {
    currentStreak++
  } else {
    // 如果是今天且无贡献，不算断签（允许今天还没开始）
    if (diff === 0) {
      continue
    }
    // 如果是非休息日且无贡献，断开
    if (!isRestDay(day.date)) {
      break
    }
    // 如果是休息日且无贡献，继续往前找（跳过）
  }
}

// 统计标签多语言
const statsLabelsMap: Record<string, { total: string; max: string; current: string }> = {
  'en': { total: 'Total', max: 'Max Streak', current: 'Current Streak' },
  'zh': { total: '共计', max: '最长连续', current: '当前连续' },
  'zh-cn': { total: '共计', max: '最长连续', current: '当前连续' },
  'zh-tw': { total: '共計', max: '最長連續', current: '當前連續' },
}

// 简单的 locale 匹配
const currentLabels = statsLabelsMap[locale?.toLowerCase() || 'en'] || statsLabelsMap.en
---

<div class="heatmap-wrapper">
  <!-- 统计概览 -->
  <div class="heatmap-stats">
    <div class="stat-item">
      <span class="stat-value">{totalContributions}</span>
      <span class="stat-label">{currentLabels.total}</span>
    </div>
    <div class="stat-item">
      <span class="stat-value">{maxStreak}</span>
      <span class="stat-label">{currentLabels.max}</span>
    </div>
    <div class="stat-item">
      <span class="stat-value">{currentStreak}</span>
      <span class="stat-label">{currentLabels.current}</span>
    </div>
  </div>

  <!-- 前半年（较早的数据） -->
  <div class="heatmap-section">
    <div class="heatmap-months">
      {firstHalfMonths.map(month => (
        <span class="heatmap-month-label" style={`left: ${month.index * 0.875}rem`}>
          {month.label}
        </span>
      ))}
    </div>
    <div class="heatmap-grid">
      {firstHalf.map((day, index) => {
        const postCount = day.posts.length
        const totalCount = postCount + day.githubCount
        const level = getLevel(totalCount)
        const colorClass = getColorClass(level, postCount > 0)
        const globalIndex = 0 + index
        const col = Math.floor(globalIndex / 7)
        const row = globalIndex % 7
        return (
          <div class="heatmap-day" data-col={col} data-row={row} style={{ animationDelay: `${globalIndex * 8}ms` }}>
            <i class={`heatmap-dot ${colorClass}`}></i>
            <div class="heatmap-tooltip">
              <time class="tooltip-date">{formatDate(day.date, locale)}</time>
              {totalCount > 0
? (
                <>
                  <p class="tooltip-count">
                    {postCount > 0 && <span>文章 {postCount} 篇</span>}
                    {postCount > 0 && day.githubCount > 0 && <span>，</span>}
                    {day.githubCount > 0 && <span>GitHub {day.githubCount} 次</span>}
                  </p>
                  {postCount > 0 && (
                    <ul class="tooltip-list">
                      {day.posts.map((post: typeof posts[0]) => (
                        <li>
                          <a href={getPostUrl(post)} class="tooltip-link">
                            {post.data.title}
                          </a>
                        </li>
                      ))}
                    </ul>
                  )}
                </>
              )
: (
                <p class="tooltip-empty">无活动</p>
              )}
            </div>
          </div>
        )
      })}
    </div>
  </div>

  <!-- 后半年（较新的数据） -->
  <div class="heatmap-section">
    <div class="heatmap-months">
      {secondHalfMonths.map(month => (
        <span class="heatmap-month-label" style={`left: ${month.index * 0.875}rem`}>
          {month.label}
        </span>
      ))}
    </div>
    <div class="heatmap-grid">
      {secondHalf.map((day, index) => {
        const postCount = day.posts.length
        const totalCount = postCount + day.githubCount
        const level = getLevel(totalCount)
        const colorClass = getColorClass(level, postCount > 0)
        const globalIndex = halfPoint + index
        const col = Math.floor(globalIndex / 7)
        const row = globalIndex % 7
        return (
          <div class="heatmap-day" data-col={col} data-row={row} style={{ animationDelay: `${globalIndex * 8}ms` }}>
            <i class={`heatmap-dot ${colorClass}`}></i>
            <div class="heatmap-tooltip">
              <time class="tooltip-date">{formatDate(day.date, locale)}</time>
              {totalCount > 0
? (
                <>
                  <p class="tooltip-count">
                    {postCount > 0 && <span>文章 {postCount} 篇</span>}
                    {postCount > 0 && day.githubCount > 0 && <span>，</span>}
                    {day.githubCount > 0 && <span>GitHub {day.githubCount} 次</span>}
                  </p>
                  {postCount > 0 && (
                    <ul class="tooltip-list">
                      {day.posts.map((post: typeof posts[0]) => (
                        <li>
                          <a href={getPostUrl(post)} class="tooltip-link">
                            {post.data.title}
                          </a>
                        </li>
                      ))}
                    </ul>
                  )}
                </>
              )
: (
                <p class="tooltip-empty">无活动</p>
              )}
            </div>
          </div>
        )
      })}
    </div>
  </div>
</div>

<script>
// 动态调整 tooltip 位置
function initTooltipPositioning() {
  const wrapper = document.querySelector('.heatmap-wrapper') as HTMLElement | null
  if (!wrapper) return

  const days = wrapper.querySelectorAll('.heatmap-day')

  days.forEach((day) => {
    const tooltip = day.querySelector('.heatmap-tooltip') as HTMLElement | null
    if (!tooltip) return

    day.addEventListener('mouseenter', () => {
      tooltip.style.removeProperty('--tooltip-offset-x')
      const dayRect = day.getBoundingClientRect()
      const viewportWidth = window.innerWidth
      tooltip.style.opacity = '0'
      tooltip.style.visibility = 'visible'
      const tooltipRect = tooltip.getBoundingClientRect()
      tooltip.style.opacity = ''
      tooltip.style.visibility = ''

      const tooltipHalfWidth = tooltipRect.width / 2
      const dayCenter = dayRect.left + dayRect.width / 2
      const tooltipLeft = dayCenter - tooltipHalfWidth
      const tooltipRight = dayCenter + tooltipHalfWidth

      if (tooltipLeft < 0) {
        const offset = -tooltipLeft + 10
        tooltip.style.setProperty('--tooltip-offset-x', `${offset}px`)
      } else if (tooltipRight > viewportWidth) {
        const offset = viewportWidth - tooltipRight - 10
        tooltip.style.setProperty('--tooltip-offset-x', `${offset}px`)
      }
    })
  })
}

// 触发热力图动画
function triggerHeatmapAnimation() {
  const days = document.querySelectorAll('.heatmap-day')
  days.forEach(day => {
    day.classList.remove('animate')
    void (day as HTMLElement).offsetWidth
    day.classList.add('animate')
  })
  
  setTimeout(() => {
    days.forEach(day => day.classList.remove('animate'))
  }, 4000)
}

// 监听主题变化
let themeObserver: MutationObserver | null = null

function initThemeObserver() {
  if (themeObserver) {
    themeObserver.disconnect()
  }

  // 初始时不触发动画，只在后续变化时触发
  let isInitializing = true 

  themeObserver = new MutationObserver((mutations) => {
    if (isInitializing) {
      isInitializing = false
      return
    }

    mutations.forEach((mutation) => {
      if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
        const oldClass = mutation.oldValue || ''
        const newClass = (mutation.target as HTMLElement).className || ''
        const wasDark = oldClass.includes('dark')
        const isDark = newClass.includes('dark')

        if (wasDark !== isDark) {
          triggerHeatmapAnimation()
        }
      }
    })
  })

  themeObserver.observe(document.documentElement, {
    attributes: true,
    attributeFilter: ['class'],
    attributeOldValue: true
  })
  
  // 稍微延迟一下标记初始化结束，避免立刻捕获到初始的类名变化（如果有的话）
  setTimeout(() => { isInitializing = false }, 100)
}

// 初始化
document.addEventListener('astro:page-load', () => {
  initTooltipPositioning()
  initThemeObserver()
})

window.addEventListener('resize', initTooltipPositioning)
</script>

<style>
  /* 外层容器 */
  .heatmap-wrapper {
    display: flex;
    flex-direction: column;
    gap: 2rem;
    width: 100%;
    margin-top: 2rem;
    margin-bottom: 0;
  }

  /* 单个热力图段 */
  .heatmap-section {
    display: block;
    width: 100%;
    overflow: visible;
  }

  .heatmap-months {
    position: relative;
    height: 1.25rem;
    margin-bottom: 0.25rem;
    width: 100%;
  }

  .heatmap-month-label {
    position: absolute;
    font-size: 0.75rem;
    line-height: 1;
    color: var(--c-text-secondary); /* Fallback */
    color: oklch(0.55 0 0); /* Default grey */
  }

  html.dark .heatmap-month-label {
    color: oklch(0.7 0 0);
  }

  .heatmap-grid {
    display: grid;
    grid-auto-flow: column;
    grid-template-rows: repeat(7, 1fr);
    gap: 0.25rem;
    width: fit-content;
    padding-bottom: 0.5rem;
  }

  .heatmap-day {
    position: relative;
    /* 默认不隐藏，也不动画 */
  }

  /* 只有添加了 .animate 类时才触发动画 */
  .heatmap-day.animate {
    opacity: 0;
    animation: heatmap-pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
  }

  @keyframes heatmap-pop {
    0% {
      opacity: 0;
      transform: scale(0.5);
    }
    100% {
      opacity: 1;
      transform: scale(1);
    }
  }

  .heatmap-dot {
    display: block;
    width: 0.625rem;
    height: 0.625rem;
    background-color: var(--heatmap-empty, #ebedf0);
    border-radius: 2px;
    transition: background-color 0.2s ease;
  }

  /* GitHub style colors (Green) - Light mode */
  .type-github-level-3 {
    background-color: var(--heatmap-github-high, #239a3b);
  }

  .type-github-level-2 {
    background-color: var(--heatmap-github-medium, #7bc96f);
  }

  .type-github-level-1 {
    background-color: var(--heatmap-github-low, #c6e48b);
  }

  .level-0 {
    background-color: var(--heatmap-empty, #ebedf0);
  }

  /* Post style colors (Claude Orange) - Light mode */
  .type-post-level-3 {
    background-color: rgb(224, 97, 62); /* #DE7356 */
  }

  .type-post-level-2 {
    background-color: rgba(222, 115, 86, 0.7);
  }

  .type-post-level-1 {
    background-color: rgb(220, 130, 106);
  }

  /* Dark mode colors */
  html.dark .heatmap-dot {
    background-color: var(--heatmap-empty-dark, #161b22);
  }

  html.dark .level-0 {
    background-color: var(--heatmap-empty-dark, #161b22);
  }

  /* GitHub Green - Dark mode */
  html.dark .type-github-level-3 {
    background-color: var(--heatmap-high-dark, #39d353);
  }

  html.dark .type-github-level-2 {
    background-color: var(--heatmap-medium-dark, #26a641);
  }

  html.dark .type-github-level-1 {
    background-color: var(--heatmap-low-dark, #0e4429);
  }

  /* Post Orange (Claude Style) - Dark mode */
  html.dark .type-post-level-3 {
    background-color: #de7356;
  }

  html.dark .type-post-level-2 {
    background-color: #914c38;
  }

  html.dark .type-post-level-1 {
    background-color: #45231a;
  }

  .heatmap-tooltip {
    --tooltip-offset-x: 0px;
    position: absolute;
    left: 50%;
    bottom: 100%;
    transform: translateX(calc(-50% + var(--tooltip-offset-x)));
    display: flex;
    flex-direction: column;
    margin-bottom: 0.5rem;
    border-radius: 0.25rem;
    padding: 0.5rem;
    font-size: 0.75rem;
    line-height: 1rem;
    width: max-content;
    max-width: 250px;
    color: #fff;
    background-color: rgba(9, 9, 9, 0.8);
    opacity: 0;
    visibility: hidden;
    z-index: 10;
    transition: opacity 0.2s, visibility 0.2s;
    pointer-events: auto;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  html.dark .heatmap-tooltip {
    background-color: rgba(30, 30, 30, 0.9);
    border-color: rgba(255, 255, 255, 0.15);
  }

  .heatmap-day:hover .heatmap-tooltip,
  .heatmap-day:has(.heatmap-tooltip:hover) .heatmap-tooltip {
    opacity: 1;
    visibility: visible;
  }

  .tooltip-date {
    font-weight: bold;
    margin-bottom: 0.25rem;
  }

  .tooltip-count {
    margin: 0.25rem 0;
  }

  .tooltip-list {
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
    margin: 0;
    padding: 0;
    list-style: none;
  }

  .tooltip-list li {
    margin-left: 0.25rem;
  }

  .tooltip-link {
    text-decoration: underline;
    text-decoration-color: transparent;
    text-underline-offset: 0.15em;
    transition: text-decoration-color 0.2s;
  }

  .tooltip-link:hover {
    text-decoration-color: currentColor;
  }

  .tooltip-empty {
    margin-top: 0.25rem;
  }

  /* Stats Section */
  .heatmap-stats {
    display: flex;
    flex-direction: row;
    gap: 1.5rem;
    padding: 0 0.5rem;
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
  }

  .stat-item {
    display: flex;
    flex-direction: row;
    align-items: baseline;
    gap: 0.25rem;
    white-space: nowrap;
  }

  .stat-value {
    font-weight: bold;
    color: var(--c-text-primary);
  }

  .stat-label {
    color: var(--c-text-secondary); /* Fallback */
    color: oklch(0.55 0 0);
  }

  html.dark .stat-label {
    color: oklch(0.7 0 0);
  }
