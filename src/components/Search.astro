---
import { themeConfig } from '@/config'

const { light, dark } = themeConfig.color
---

<site-search>
  <dialog id="search-dialog" class="z-[999] m-auto hidden h-full max-h-full max-w-full w-full items-center justify-center bg-transparent p-0 open:flex backdrop:bg-gray-900/50">
    <div class="relative max-h-[80vh] max-w-2xl w-full overflow-y-auto border border-gray-200 rounded-lg bg-white p-6 text-gray-900 shadow-xl dark:border-gray-700 dark:bg-[#1a1a1a] dark:text-gray-100">
      <div class="mb-4 flex items-center justify-between">
        <h2 class="text-xl font-bold">Search</h2>
        <button class="close-btn cursor-pointer rounded p-2 transition-colors hover:bg-gray-100 dark:hover:bg-gray-800" aria-label="Close search">
           <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12z" /></svg>
        </button>
      </div>
      <div id="pagefind-search"></div>
    </div>
  </dialog>
</site-search>

<script>
class SiteSearch extends HTMLElement {
  constructor() {
    super()
    this.onOpen = this.onOpen.bind(this)
    this.onKeydown = this.onKeydown.bind(this)
  }

  connectedCallback() {
    const dialog = this.querySelector('dialog')
    const closeBtn = this.querySelector('.close-btn')

    if (!dialog)
      return

    // Open event listener
    window.addEventListener('open-search', this.onOpen)

    // Close event listeners
    closeBtn?.addEventListener('click', () => dialog.close())
    dialog.addEventListener('click', (e) => {
      if (e.target === dialog)
        dialog.close()
    })

    // Shortcut listener
    window.addEventListener('keydown', this.onKeydown)
  }

  disconnectedCallback() {
    window.removeEventListener('open-search', this.onOpen)
    window.removeEventListener('keydown', this.onKeydown)
  }

  onOpen() {
    const dialog = this.querySelector('dialog')
    if (dialog && !dialog.open) {
      dialog.showModal()
      this.loadPagefind()
    }
  }

  onKeydown(e: KeyboardEvent) {
    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
      e.preventDefault()
      this.onOpen()
    }
  }

  async loadPagefind() {
    // @ts-expect-error: PagefindUI is loaded globally
    if (window.pagefindUI)
      return

    const script = document.createElement('script')
    script.src = '/pagefind/pagefind-ui.js'
    script.onload = () => {
      // @ts-expect-error: PagefindUI is loaded globally
      void new PagefindUI({
        element: '#pagefind-search',
        showSubResults: true,
        showImages: false,
      })
      // @ts-expect-error: PagefindUI is loaded globally
      window.pagefindUI = true
    }
    script.onerror = () => {
      const container = document.getElementById('pagefind-search')
      if (container) {
        container.innerHTML = '<div class="flex flex-col items-center gap-2 text-center text-red-500"><p>Search is only available in production builds.</p><p class="text-sm text-gray-500 dark:text-gray-400">Run <code class="rounded bg-gray-100 px-1 py-0.5 dark:bg-gray-800">pnpm build && pnpm preview</code> to test.</p></div>'
      }
    }
    document.body.appendChild(script)

    const link = document.createElement('link')
    link.rel = 'stylesheet'
    link.href = '/pagefind/pagefind-ui.css'
    document.head.appendChild(link)
  }
}

customElements.define('site-search', SiteSearch)
</script>

<style
  is:global
  define:vars={{
  'light-primary': light.primary,
  'light-text': light.secondary,
  'light-bg': light.background,
  'light-border': light.highlight,
  'dark-primary': dark.primary,
  'dark-text': dark.secondary,
  'dark-bg': dark.background,
  'dark-border': dark.highlight,
}}
>
  :root {
    --pagefind-ui-scale: 1;
    --pagefind-ui-primary: var(--light-primary);
    --pagefind-ui-text: var(--light-text);
    --pagefind-ui-background: var(--light-bg);
    --pagefind-ui-border: var(--light-border);
    --pagefind-ui-tag: var(--light-border);
    --pagefind-ui-border-width: 1px;
    --pagefind-ui-border-radius: 0.5rem;
    --pagefind-ui-font: inherit;
  }

  html.dark {
    --pagefind-ui-primary: var(--dark-primary);
    --pagefind-ui-text: var(--dark-text);
    --pagefind-ui-background: var(--dark-bg);
    --pagefind-ui-border: var(--dark-border);
    --pagefind-ui-tag: var(--dark-border);
  }
</style>
