---
import LanguageSwitcherIcon from '@/assets/icons/language-switcher.svg'
import { moreLocales, themeConfig } from '@/config'
import { getNextGlobalLangPath, getNextSupportedLangPath } from '@/i18n/path'

interface Props {
  supportedLangs: string[]
  class?: string
}

const {
  light: { background: lightMode },
  dark: { background: darkMode },
} = themeConfig.color

const { supportedLangs, class: className } = Astro.props
const currentPath = Astro.url.pathname

// Check if there are other languages to switch
const showLanguageSwitcher = moreLocales.length > 0
// Choose a language switch list according to supported languages
const nextUrl = supportedLangs.length > 0
  ? getNextSupportedLangPath(currentPath, supportedLangs) // Use supported languages when available
  : getNextGlobalLangPath(currentPath) // Fallback to all languages when no supported languages data
---

<div
  class:list={[
    className,
    'flex gap-6',
  ]}
>
  <!-- Language Switcher -->
  {showLanguageSwitcher && (
    <a
      id="language-switcher"
      href={nextUrl}
      class="aspect-square w-4 c-secondary active:scale-90 hover:c-primary"
      aria-label="Switch website language"
    >
      <LanguageSwitcherIcon
        aria-hidden="true"
        fill="currentColor"
      />
    </a>
  )}

  <!-- Activity Toggle -->
  <button
    class="activity-toggle-button aspect-square w-4 c-secondary active:scale-90 hover:c-primary"
    aria-label="Toggle activity stream"
  >
    <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
      <line x1="9" y1="3" x2="9" y2="21" />
    </svg>
  </button>

  <!-- Theme Toggle -->
  <button
    class="theme-toggle-button aspect-square w-4 c-secondary active:scale-90 hover:c-primary"
    aria-label="Switch light/dark theme"
  >
    <div class="hidden dark:block">
      <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="4" />
        <path d="M12 2v2" />
        <path d="M12 20v2" />
        <path d="M4.93 4.93l1.41 1.41" />
        <path d="M17.66 17.66l1.41 1.41" />
        <path d="M2 12h2" />
        <path d="M20 12h2" />
        <path d="M6.34 17.66l-1.41 1.41" />
        <path d="M19.07 4.93l-1.41 1.41" />
      </svg>
    </div>
    <div class="block dark:hidden">
      <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z" />
      </svg>
    </div>
  </button>

  <!-- Springy Cursor Toggle -->
  <button
    class="springy-cursor-toggle-button aspect-square w-4 c-secondary active:scale-90 hover:c-primary"
    aria-label="Toggle springy cursor"
  >
    <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="9" />
      <path d="M12 7l4.76 3.45l-1.76 5.55h-6l-1.76 -5.55z" />
      <path d="M12 7v-4" />
      <path d="M15 13l3.4 3.4" />
      <path d="M9 13l-3.4 3.4" />
      <path d="M16.76 10.45l3.24 -1.45" />
      <path d="M7.24 10.45l-3.24 -1.45" />
    </svg>
  </button>
</div>

<!-- Theme Toggle Script >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> -->
<script
  is:inline
  define:vars={{
    lightMode,
    darkMode,
 }}
>
// Prevent multiple initializations
if (!window.themeToggleInitialized) {
  window.themeToggleInitialized = true

  // Apply theme changes
  function applyTheme(isDark) {
    document.documentElement.classList.toggle('dark', isDark)

    // Update meta theme-color tag
    const metaThemeColor = document.head.querySelector('meta[name="theme-color"]')
    if (metaThemeColor && lightMode && darkMode) {
      metaThemeColor.setAttribute('content', isDark ? darkMode : lightMode)
    }

    localStorage.setItem('theme', isDark ? 'dark' : 'light')
    document.dispatchEvent(new Event('theme-changed'))
  }

  // Toggle theme mode
  function toggleTheme() {
    const isDark = !document.documentElement.classList.contains('dark')
    applyTheme(isDark)
  }

  // Handle theme toggle click events
  function handleThemeToggleClick(e) {
    const target = e.target instanceof Element ? e.target : null
    const button = target?.closest('.theme-toggle-button')

    if (!button) {
      return
    }

    // If reduceMotion is enabled, update theme directly
    if (document.documentElement.classList.contains('reduce-motion')) {
      toggleTheme()
      return
    }

    // Add temporary markers before view transition
    document.documentElement.style.setProperty('view-transition-name', 'animation-theme-toggle')
    document.documentElement.setAttribute('data-theme-changing', '')

    // Use View Transitions API for theme toggle
    const transition = document.startViewTransition(toggleTheme)

    // Remove temporary markers after view transition
    transition.finished.then(() => {
      document.documentElement.style.removeProperty('view-transition-name')
      document.documentElement.removeAttribute('data-theme-changing')
    })
  }

  // Bind click event to the button
  document.addEventListener('click', handleThemeToggleClick, { passive: true })

  // Listen to system theme changes in real time
  window.matchMedia('(prefers-color-scheme: dark)')
    .addEventListener('change', (event) => {
      const isDark = event.matches
      // Apply system theme preference
      applyTheme(isDark)
    })
}

// Activity Toggle Logic
if (!window.activityToggleInitialized) {
  window.activityToggleInitialized = true

  function setupActivityToggle() {
    const toggleBtns = document.querySelectorAll('.activity-toggle-button')
    const sidebar = document.getElementById('left-sidebar')
    const placeholder = document.getElementById('left-sidebar-placeholder')
    const ACTIVITY_HIDDEN_KEY = 'activity-hidden'

    // If no buttons exist, do nothing
    if (toggleBtns.length === 0)
      return

    const updateState = () => {
      const isHidden = localStorage.getItem(ACTIVITY_HIDDEN_KEY) !== 'false'

      // Update ALL buttons state
      toggleBtns.forEach((btn) => {
        btn.classList.toggle('opacity-50', isHidden)
      })

      const target = sidebar || placeholder

      if (target) {
        // Use visible/invisible to preserve layout space
        if (isHidden) {
          target.classList.add('invisible')
        }
        else {
          target.classList.remove('invisible')
        }
      }
    }

    // Initial Check
    updateState()

    // Add listeners to ALL buttons
    toggleBtns.forEach((btn) => {
      btn.addEventListener('click', () => {
        const isHidden = localStorage.getItem(ACTIVITY_HIDDEN_KEY) !== 'false'
        localStorage.setItem(ACTIVITY_HIDDEN_KEY, (!isHidden).toString())
        updateState()
      })
    })
  }

  // Run on initial load
  setupActivityToggle()

  // Run on view transitions
  document.addEventListener('astro:after-swap', setupActivityToggle)
}

// Springy Cursor Toggle Logic
if (!window.springyCursorToggleInitialized) {
  window.springyCursorToggleInitialized = true

  function setupSpringyCursorToggle() {
    const toggleBtns = document.querySelectorAll('.springy-cursor-toggle-button')
    const STORAGE_KEY = 'springy-cursor-enabled'

    if (toggleBtns.length === 0)
      return

    const updateState = () => {
      const isEnabled = localStorage.getItem(STORAGE_KEY) !== 'false'
      toggleBtns.forEach((btn) => {
        btn.classList.toggle('opacity-50', !isEnabled)
      })
    }

    // Initial Check
    updateState()

    // Add listeners to ALL buttons
    toggleBtns.forEach((btn) => {
      btn.addEventListener('click', () => {
        const isEnabled = localStorage.getItem(STORAGE_KEY) !== 'false'
        localStorage.setItem(STORAGE_KEY, (!isEnabled).toString())
        const event = new Event('springy-cursor-toggle')
        window.dispatchEvent(event)
        updateState()
      })
    })
  }

  setupSpringyCursorToggle()
  document.addEventListener('astro:after-swap', setupSpringyCursorToggle)
}
</script>
