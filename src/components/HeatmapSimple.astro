---
/**
 * 简化版热力图组件 - 纯 Astro 实现
 * 不依赖 Svelte，不需要客户端 JS
 */
import { getPostPath } from '@/i18n/path'
import { getGitHubContributions } from '@/utils/github-contributions'
import { addDays, diffDays, formatDate, getWeekday, subtractDays } from '@/utils/time-simple'

interface Props {
  posts: Array<{
    id: string
    data: {
      title: string
      published: Date
      abbrlink?: string
      [key: string]: any
    }
  }>
  locale?: string
  lang?: string
  startDate?: string // 可选：指定开始日期 (YYYY-MM-DD)
  githubUser?: string
}

const { posts, locale = 'zh-CN', lang = '', startDate, githubUser } = Astro.props
const now = new Date()

// 确定起始日期和天数
let start: Date
let days: number

if (startDate) {
  // 自定义模式：从指定日期对齐到周六后往前显示一年
  const customDate = new Date(startDate)
  const weekday = getWeekday(customDate)
  // 如果不是周六，找到这周或下周的周六
  const daysUntilSaturday = weekday === 6 ? 0 : (6 - weekday + 7) % 7
  start = addDays(customDate, daysUntilSaturday)
  days = 52 * 7 // 固定显示52周(一年)
}
 else {
  // 默认模式：从今天对齐到周六后往前显示一年
  const weekday = getWeekday(now)
  // 如果今天是周六，就用今天；否则用上周六
  const daysToLastSaturday = weekday === 6 ? 0 : weekday + 1
  start = subtractDays(now, daysToLastSaturday)
  days = 52 * 7 // 固定显示52周(一年)
}

// 获取 GitHub 数据
let githubData = new Map<string, number>()
if (githubUser) {
  githubData = await getGitHubContributions(githubUser)
}

// 创建热力图数据结构
type HeatmapDay = {
  date: Date
  posts: typeof posts
  githubCount: number
}

const heatmap: HeatmapDay[] = Array.from({ length: days }, (_, day) => ({
  date: subtractDays(start, day),
  posts: [],
  githubCount: 0,
}))

// 填充文章数据
for (const post of posts) {
  const postDate = post.data.published
  if (!postDate)
    continue

  const gap = diffDays(start, postDate)
  if (gap >= 0 && gap < days) {
    heatmap[gap].posts.push(post)
  }
}

// 填充 GitHub 数据
if (githubUser) {
  heatmap.forEach((day) => {
    const dateStr = day.date.toISOString().split('T')[0]
    if (githubData.has(dateStr)) {
      day.githubCount = githubData.get(dateStr)!
    }
  })
}

// 反转数组，让最新的在右边
heatmap.reverse()

// 拆分成两个半年的热力图
const halfPoint = Math.ceil(heatmap.length / 2)
const firstHalf = heatmap.slice(0, halfPoint) // 前半年（较早）
const secondHalf = heatmap.slice(halfPoint) // 后半年（较新）

// 生成文章链接
function getPostUrl(post: typeof posts[0]): string {
  // 使用 abbrlink 或 id 作为 slug
  const slug = post.data.abbrlink || post.id
  return getPostPath(slug, lang)
}

// 辅助函数：计算活跃等级
function getLevel(count: number): number {
  if (count >= 5)
return 3
  if (count >= 3)
return 2
  if (count >= 1)
return 1
  return 0
}

// 辅助函数：获取颜色类名
function getColorClass(level: number, hasPost: boolean): string {
  if (level === 0)
return 'level-0'
  const type = hasPost ? 'post' : 'github'
  return `type-${type}-level-${level}`
}
---

<div class="heatmap-wrapper">
  <!-- 后半年（较新的数据） -->
  <div class="heatmap-section">
    <div class="heatmap-grid">
      {secondHalf.map((day, index) => {
        const postCount = day.posts.length
        const totalCount = postCount + day.githubCount
        const level = getLevel(totalCount)
        const colorClass = getColorClass(level, postCount > 0)
        const globalIndex = halfPoint + index
        const col = Math.floor(globalIndex / 7)
        const row = globalIndex % 7
        return (
          <div class="heatmap-day" data-col={col} data-row={row}>
            <i class={`heatmap-dot ${colorClass}`}></i>
            <div class="heatmap-tooltip">
              <time class="tooltip-date">{formatDate(day.date, locale)}</time>
              {totalCount > 0
? (
                <>
                  <p class="tooltip-count">
                    {postCount > 0 && <span>文章 {postCount} 篇</span>}
                    {postCount > 0 && day.githubCount > 0 && <span>，</span>}
                    {day.githubCount > 0 && <span>GitHub {day.githubCount} 次</span>}
                  </p>
                  {postCount > 0 && (
                    <ul class="tooltip-list">
                      {day.posts.map((post: typeof posts[0]) => (
                        <li>
                          <a href={getPostUrl(post)} class="tooltip-link">
                            {post.data.title}
                          </a>
                        </li>
                      ))}
                    </ul>
                  )}
                </>
              )
: (
                <p class="tooltip-empty">无活动</p>
              )}
            </div>
          </div>
        )
      })}
    </div>
  </div>

  <!-- 前半年（较早的数据） -->
  <div class="heatmap-section">
    <div class="heatmap-grid">
      {firstHalf.map((day, index) => {
        const postCount = day.posts.length
        const totalCount = postCount + day.githubCount
        const level = getLevel(totalCount)
        const colorClass = getColorClass(level, postCount > 0)
        const globalIndex = 0 + index
        const col = Math.floor(globalIndex / 7)
        const row = globalIndex % 7
        return (
          <div class="heatmap-day" data-col={col} data-row={row}>
            <i class={`heatmap-dot ${colorClass}`}></i>
            <div class="heatmap-tooltip">
              <time class="tooltip-date">{formatDate(day.date, locale)}</time>
              {totalCount > 0
? (
                <>
                  <p class="tooltip-count">
                    {postCount > 0 && <span>文章 {postCount} 篇</span>}
                    {postCount > 0 && day.githubCount > 0 && <span>，</span>}
                    {day.githubCount > 0 && <span>GitHub {day.githubCount} 次</span>}
                  </p>
                  {postCount > 0 && (
                    <ul class="tooltip-list">
                      {day.posts.map((post: typeof posts[0]) => (
                        <li>
                          <a href={getPostUrl(post)} class="tooltip-link">
                            {post.data.title}
                          </a>
                        </li>
                      ))}
                    </ul>
                  )}
                </>
              )
: (
                <p class="tooltip-empty">无活动</p>
              )}
            </div>
          </div>
        )
      })}
    </div>
  </div>
</div>

<script>
// 动态调整 tooltip 位置，避免被遮挡
function initTooltipPositioning() {
  const wrapper = document.querySelector('.heatmap-wrapper') as HTMLElement | null
  if (!wrapper)
    return

  const days = wrapper.querySelectorAll('.heatmap-day')

  days.forEach((day) => {
    const tooltip = day.querySelector('.heatmap-tooltip') as HTMLElement | null
    if (!tooltip)
      return

    day.addEventListener('mouseenter', () => {
      // 重置偏移
      tooltip.style.removeProperty('--tooltip-offset-x')

      const dayRect = day.getBoundingClientRect()

      // 获取视口宽度
      const viewportWidth = window.innerWidth

      // 先让 tooltip 显示以获取宽度
      tooltip.style.opacity = '0'
      tooltip.style.visibility = 'visible'
      const tooltipRect = tooltip.getBoundingClientRect()
      tooltip.style.opacity = ''
      tooltip.style.visibility = ''

      const tooltipHalfWidth = tooltipRect.width / 2
      const dayCenter = dayRect.left + dayRect.width / 2

      // 计算 tooltip 居中后的左右边界
      const tooltipLeft = dayCenter - tooltipHalfWidth
      const tooltipRight = dayCenter + tooltipHalfWidth

      // 如果会超出左边界，向右调整
      if (tooltipLeft < 0) {
        const offset = -tooltipLeft + 10 // 10px 额外边距
        tooltip.style.setProperty('--tooltip-offset-x', `${offset}px`)
      }
      // 如果会超出右边界，向左调整
      else if (tooltipRight > viewportWidth) {
        const offset = viewportWidth - tooltipRight - 10
        tooltip.style.setProperty('--tooltip-offset-x', `${offset}px`)
      }
    })
  })
}

// 初始化
initTooltipPositioning()

// 处理动态内容加载和窗口大小变化
document.addEventListener('astro:page-load', initTooltipPositioning)
window.addEventListener('resize', initTooltipPositioning)
</script>

<style>
  /* 外层容器 */
  .heatmap-wrapper {
    display: flex;
    flex-direction: column;
    gap: 2rem;
    width: 100%;
    margin-top: 2rem;
    margin-bottom: 0;
  }

  /* 单个热力图段 */
  .heatmap-section {
    display: block;
    width: 100%;
    overflow: visible;
  }

  .heatmap-grid {
    display: grid;
    grid-auto-flow: column;
    grid-template-rows: repeat(7, 1fr);
    gap: 0.25rem;
    width: fit-content;
    padding-bottom: 0.5rem;
  }

  .heatmap-day {
    position: relative;
  }

  .heatmap-dot {
    display: block;
    width: 0.625rem;
    height: 0.625rem;
    background-color: var(--heatmap-empty, #ebedf0);
    border-radius: 2px;
    transition: background-color 0.2s ease;
  }

  /* GitHub style colors (Green) - Light mode */
  .type-github-level-3 {
    background-color: var(--heatmap-github-high, #239a3b);
  }

  .type-github-level-2 {
    background-color: var(--heatmap-github-medium, #7bc96f);
  }

  .type-github-level-1 {
    background-color: var(--heatmap-github-low, #c6e48b);
  }

  .level-0 {
    background-color: var(--heatmap-empty, #ebedf0);
  }

  /* Post style colors (Claude Orange) - Light mode */
  .type-post-level-3 {
    background-color: rgb(224, 97, 62); /* #DE7356 */
  }

  .type-post-level-2 {
    background-color: rgba(222, 115, 86, 0.7);
  }

  .type-post-level-1 {
    background-color: rgb(220, 130, 106);
  }

  /* Dark mode colors */
  html.dark .heatmap-dot {
    background-color: var(--heatmap-empty-dark, #161b22);
  }

  html.dark .level-0 {
    background-color: var(--heatmap-empty-dark, #161b22);
  }

  /* GitHub Green - Dark mode */
  html.dark .type-github-level-3 {
    background-color: var(--heatmap-high-dark, #39d353);
  }

  html.dark .type-github-level-2 {
    background-color: var(--heatmap-medium-dark, #26a641);
  }

  html.dark .type-github-level-1 {
    background-color: var(--heatmap-low-dark, #0e4429);
  }

  /* Post Orange (Claude Style) - Dark mode */
  html.dark .type-post-level-3 {
    background-color: #de7356;
  }

  html.dark .type-post-level-2 {
    background-color: #914c38;
  }

  html.dark .type-post-level-1 {
    background-color: #45231a;
  }

  .heatmap-tooltip {
    --tooltip-offset-x: 0px;
    position: absolute;
    left: 50%;
    bottom: 100%;
    transform: translateX(calc(-50% + var(--tooltip-offset-x)));
    display: flex;
    flex-direction: column;
    margin-bottom: 0.5rem;
    border-radius: 0.25rem;
    padding: 0.5rem;
    font-size: 0.75rem;
    line-height: 1rem;
    width: max-content;
    max-width: 250px;
    color: #fff;
    background-color: rgba(9, 9, 9, 0.8);
    opacity: 0;
    visibility: hidden;
    z-index: 10;
    transition: opacity 0.2s, visibility 0.2s;
    pointer-events: auto;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  html.dark .heatmap-tooltip {
    background-color: rgba(30, 30, 30, 0.9);
    border-color: rgba(255, 255, 255, 0.15);
  }

  .heatmap-day:hover .heatmap-tooltip,
  .heatmap-day:has(.heatmap-tooltip:hover) .heatmap-tooltip {
    opacity: 1;
    visibility: visible;
  }

  .tooltip-date {
    font-weight: bold;
    margin-bottom: 0.25rem;
  }

  .tooltip-count {
    margin: 0.25rem 0;
  }

  .tooltip-list {
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
    margin: 0;
    padding: 0;
    list-style: none;
  }

  .tooltip-list li {
    margin-left: 0.25rem;
  }

  .tooltip-link {
    text-decoration: underline;
    text-decoration-color: transparent;
    text-underline-offset: 0.15em;
    transition: text-decoration-color 0.2s;
  }

  .tooltip-link:hover {
    text-decoration-color: currentColor;
  }

  .tooltip-empty {
    margin-top: 0.25rem;
  }
</style>
